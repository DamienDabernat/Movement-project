<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.7.0/lib/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/addons/p5.sound.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div id="error"></div>
<div id="safari">Autoriser l'accéléromètre</div>
<script src="utils.js"></script>
<script>
    let osc;
    let isPlaying = false; // Variable pour suivre l'état de l'oscillateur
    let freq, amp;

    function setup() {
        let cnv = createCanvas(400, 400);
        cnv.mousePressed(toggleOscillator);
        osc = new p5.Oscillator('sine');

        if (!window.DeviceMotionEvent) {
            document.getElementById('error').innerHTML = 'Device motion API not supported';
        } else {
            requestPermission()
                .then(() => {
                    window.addEventListener("devicemotion", drawWithMotion, false);
                })
                .catch(err => {
                    console.error('An error occurred:', err);
                });
        }
    }

    function draw() {
        background(220);
        text('tap to play', 20, 20);
        text('freq: ' + freq, 20, 40);
        text('amp: ' + amp, 20, 60);
    }

    function drawWithMotion(event) {
        const accel = event.accelerationIncludingGravity;
        const factor = is_iOS() ? -1 : 1;

        let newX = map(accel.x * factor, -10, 10, 100, 500);
        let newY = map(accel.y * factor, -10, 10, 0, 1);

        console.log(newX, newY)

        freq = constrain(newX, 100, 500);
        amp = constrain(newY, 0, 1);

        if (isPlaying) {
            osc.freq(freq, 0.1);
            osc.amp(amp, 0.1);
        }
    }

    function toggleOscillator() { // Fonction pour démarrer/arrêter l'oscillateur
        if (isPlaying) {
            osc.amp(0, 0.5);
            isPlaying = false;
        } else {
            osc.start();
            isPlaying = true;
        }
    }
</script>
</body>
</html>
